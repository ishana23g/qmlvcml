
from unittest.mock import patch 

import pandas as pd
import pennylane as qml
from pennylane import numpy as np

from qmlvcml import *

import pytest

@qml.qnode(dev)
def apply_state_prep(angles):
    state_preparation(angles)
    return qml.state()

def test_state_preparation():
    x = np.array([0.53896774, 0.79503606, 0.27826503, 0.0], requires_grad=False)
    ang = get_angles(x)
    assert np.allclose(ang, [0.563975, -0., 0., -0.975046, 0.975046]), "Did not get the correct angles"
    # same as test_get_angles
    ang_amplituides = np.real(apply_state_prep(ang))
    assert np.allclose(ang_amplituides, [0.53896774, 0.79503606, 0.27826503, 0.0]), "Did not get the correct amplitudes"

def test_with_banana(monkeypatch):
    banana_df_X, banana_df_y = read_banana_data()
    monkeypatch.setattr(plt, 'show', lambda: None)
    apply_model(banana_df_X, banana_df_y, steps=1,
                     batch_size_percent=.8, isPlot=True, isDebug=True,
                     dim_reduce_type='trimap')
    # no debug
    apply_model(banana_df_X, banana_df_y, steps=1,
                     batch_size_percent=.8, isPlot=True, isDebug=False,
                     dim_reduce_type='trimap')
    # no plot
    apply_model(banana_df_X, banana_df_y, steps=1,
                     batch_size_percent=.8, isPlot=False, isDebug=False,
                     dim_reduce_type='trimap')

def _iris_data():
    # Data from penny lane
    # https://raw.githubusercontent.com/XanaduAI/qml/master/_static/demonstration_assets/variational_classifier/data/iris_classes1and2_scaled.txt
    data = [[3.999999999999999112e-01, 7.500000000000000000e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.000000000000002665e-01, 5.000000000000000000e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [2.000000000000001776e-01, 6.000000000000000888e-01, 1.500000000000000222e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [1.499999999999999112e-01, 5.500000000000000444e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 8.000000000000000444e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [5.500000000000002665e-01, 9.499999999999999556e-01, 3.499999999999999778e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [1.499999999999999112e-01, 6.999999999999999556e-01, 1.999999999999999556e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 6.999999999999999556e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [5.000000000000026645e-02, 4.499999999999999556e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.000000000000002665e-01, 5.500000000000000444e-01, 2.500000000000000000e-01, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [5.500000000000002665e-01, 8.500000000000000888e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [2.500000000000000000e-01, 6.999999999999999556e-01, 3.000000000000000444e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [2.500000000000000000e-01, 5.000000000000000000e-01, 1.999999999999999556e-01, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [0.000000000000000000e+00, 5.000000000000000000e-01, 5.000000000000004441e-02, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [7.500000000000000000e-01, 1.000000000000000000e+00, 9.999999999999997780e-02, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [7.000000000000001776e-01, 1.200000000000000178e+00, 2.500000000000000000e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [5.500000000000002665e-01, 9.499999999999999556e-01, 1.500000000000000222e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 7.500000000000000000e-01, 1.999999999999999556e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [7.000000000000001776e-01, 8.999999999999999112e-01, 3.499999999999999778e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 8.999999999999999112e-01, 2.500000000000000000e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [5.500000000000002665e-01, 6.999999999999999556e-01, 3.499999999999999778e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 8.500000000000000888e-01, 2.500000000000000000e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [1.499999999999999112e-01, 8.000000000000000444e-01, 0.000000000000000000e+00, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 6.499999999999999112e-01, 3.499999999999999778e-01, 2.000000000000000111e-01, -1.000000000000000000e+00],
    [2.500000000000000000e-01, 6.999999999999999556e-01, 4.499999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 5.000000000000000000e-01, 3.000000000000000444e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 6.999999999999999556e-01, 3.000000000000000444e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [4.500000000000001776e-01, 7.500000000000000000e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [4.500000000000001776e-01, 6.999999999999999556e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [2.000000000000001776e-01, 6.000000000000000888e-01, 3.000000000000000444e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [2.500000000000000000e-01, 5.500000000000000444e-01, 3.000000000000000444e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [5.500000000000002665e-01, 6.999999999999999556e-01, 2.500000000000000000e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [4.500000000000001776e-01, 1.049999999999999822e+00, 2.500000000000000000e-01, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [6.000000000000000888e-01, 1.100000000000000089e+00, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.000000000000002665e-01, 5.500000000000000444e-01, 2.500000000000000000e-01, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 6.000000000000000888e-01, 9.999999999999997780e-02, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [6.000000000000000888e-01, 7.500000000000000000e-01, 1.500000000000000222e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.000000000000002665e-01, 5.500000000000000444e-01, 2.500000000000000000e-01, 0.000000000000000000e+00, -1.000000000000000000e+00],
    [5.000000000000026645e-02, 5.000000000000000000e-01, 1.500000000000000222e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 6.999999999999999556e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 7.500000000000000000e-01, 1.500000000000000222e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [1.000000000000000888e-01, 1.499999999999999112e-01, 1.500000000000000222e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [5.000000000000026645e-02, 6.000000000000000888e-01, 1.500000000000000222e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 7.500000000000000000e-01, 3.000000000000000444e-01, 2.500000000000000000e-01, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 8.999999999999999112e-01, 4.499999999999999556e-01, 1.500000000000000222e-01, -1.000000000000000000e+00],
    [2.500000000000000000e-01, 5.000000000000000000e-01, 1.999999999999999556e-01, 9.999999999999999167e-02, -1.000000000000000000e+00],
    [3.999999999999999112e-01, 8.999999999999999112e-01, 3.000000000000000444e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [1.499999999999999112e-01, 6.000000000000000888e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [5.000000000000000000e-01, 8.500000000000000888e-01, 2.500000000000000000e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [3.500000000000000888e-01, 6.499999999999999112e-01, 1.999999999999999556e-01, 5.000000000000000278e-02, -1.000000000000000000e+00],
    [1.350000000000000089e+00, 6.000000000000000888e-01, 1.850000000000000089e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [1.050000000000000266e+00, 6.000000000000000888e-01, 1.750000000000000000e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [1.300000000000000266e+00, 5.500000000000000444e-01, 1.950000000000000178e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [6.000000000000000888e-01, 1.499999999999999112e-01, 1.500000000000000000e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [1.100000000000000089e+00, 3.999999999999999112e-01, 1.799999999999999822e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [7.000000000000001776e-01, 3.999999999999999112e-01, 1.750000000000000000e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [1.000000000000000000e+00, 6.499999999999999112e-01, 1.850000000000000089e+00, 7.500000000000000000e-01, 1.000000000000000000e+00],
    [3.000000000000002665e-01, 1.999999999999999556e-01, 1.149999999999999911e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [1.149999999999999911e+00, 4.499999999999999556e-01, 1.799999999999999822e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [4.500000000000001776e-01, 3.500000000000000888e-01, 1.449999999999999956e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [3.500000000000000888e-01, 0.000000000000000000e+00, 1.250000000000000000e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [8.000000000000002665e-01, 5.000000000000000000e-01, 1.600000000000000089e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [8.500000000000000888e-01, 1.000000000000000888e-01, 1.500000000000000000e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [8.999999999999999112e-01, 4.499999999999999556e-01, 1.850000000000000089e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [6.499999999999999112e-01, 4.499999999999999556e-01, 1.300000000000000044e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [1.200000000000000178e+00, 5.500000000000000444e-01, 1.700000000000000178e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [6.499999999999999112e-01, 5.000000000000000000e-01, 1.750000000000000000e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [7.500000000000000000e-01, 3.500000000000000888e-01, 1.549999999999999822e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [9.500000000000001776e-01, 1.000000000000000888e-01, 1.750000000000000000e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [6.499999999999999112e-01, 2.500000000000000000e-01, 1.449999999999999956e+00, 5.000000000000000000e-01, 1.000000000000000000e+00],
    [8.000000000000002665e-01, 6.000000000000000888e-01, 1.899999999999999911e+00, 8.499999999999999778e-01, 1.000000000000000000e+00],
    [8.999999999999999112e-01, 3.999999999999999112e-01, 1.500000000000000000e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [1.000000000000000000e+00, 2.500000000000000000e-01, 1.950000000000000178e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [8.999999999999999112e-01, 3.999999999999999112e-01, 1.850000000000000089e+00, 5.499999999999999334e-01, 1.000000000000000000e+00],
    [1.050000000000000266e+00, 4.499999999999999556e-01, 1.649999999999999911e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [1.149999999999999911e+00, 5.000000000000000000e-01, 1.700000000000000178e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [1.250000000000000000e+00, 3.999999999999999112e-01, 1.899999999999999911e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [1.200000000000000178e+00, 5.000000000000000000e-01, 2.000000000000000000e+00, 7.999999999999999334e-01, 1.000000000000000000e+00],
    [8.500000000000000888e-01, 4.499999999999999556e-01, 1.750000000000000000e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [7.000000000000001776e-01, 3.000000000000000444e-01, 1.250000000000000000e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [6.000000000000000888e-01, 1.999999999999999556e-01, 1.399999999999999911e+00, 5.000000000000000000e-01, 1.000000000000000000e+00],
    [6.000000000000000888e-01, 1.999999999999999556e-01, 1.350000000000000089e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [7.500000000000000000e-01, 3.500000000000000888e-01, 1.449999999999999956e+00, 5.499999999999999334e-01, 1.000000000000000000e+00],
    [8.500000000000000888e-01, 3.500000000000000888e-01, 2.049999999999999822e+00, 7.500000000000000000e-01, 1.000000000000000000e+00],
    [5.500000000000002665e-01, 5.000000000000000000e-01, 1.750000000000000000e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [8.500000000000000888e-01, 6.999999999999999556e-01, 1.750000000000000000e+00, 7.500000000000000000e-01, 1.000000000000000000e+00],
    [1.200000000000000178e+00, 5.500000000000000444e-01, 1.850000000000000089e+00, 6.999999999999999556e-01, 1.000000000000000000e+00],
    [1.000000000000000000e+00, 1.499999999999999112e-01, 1.700000000000000178e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [6.499999999999999112e-01, 5.000000000000000000e-01, 1.549999999999999822e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [6.000000000000000888e-01, 2.500000000000000000e-01, 1.500000000000000000e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [6.000000000000000888e-01, 3.000000000000000444e-01, 1.700000000000000178e+00, 5.499999999999999334e-01, 1.000000000000000000e+00],
    [8.999999999999999112e-01, 5.000000000000000000e-01, 1.799999999999999822e+00, 6.499999999999999112e-01, 1.000000000000000000e+00],
    [7.500000000000000000e-01, 3.000000000000000444e-01, 1.500000000000000000e+00, 5.499999999999999334e-01, 1.000000000000000000e+00],
    [3.500000000000000888e-01, 1.499999999999999112e-01, 1.149999999999999911e+00, 4.500000000000000111e-01, 1.000000000000000000e+00],
    [6.499999999999999112e-01, 3.500000000000000888e-01, 1.600000000000000089e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [7.000000000000001776e-01, 5.000000000000000000e-01, 1.600000000000000089e+00, 5.499999999999999334e-01, 1.000000000000000000e+00],
    [7.000000000000001776e-01, 4.499999999999999556e-01, 1.600000000000000089e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [9.500000000000001776e-01, 4.499999999999999556e-01, 1.649999999999999911e+00, 5.999999999999999778e-01, 1.000000000000000000e+00],
    [3.999999999999999112e-01, 2.500000000000000000e-01, 1.000000000000000000e+00, 5.000000000000000000e-01, 1.000000000000000000e+00],
    [7.000000000000001776e-01, 3.999999999999999112e-01, 1.549999999999999822e+00, 5.999999999999999778e-01, 1.000000000000000000e+00]]
    data = pd.DataFrame(data, columns=['SepalLength', 'SepalWidth', 'PetalLength', 'PetalWidth', 'Species'])
    X = data[['SepalLength', 'SepalWidth']]
    y = data['Species']
    return X, y

def test_vqml_fails(monkeypatch):
    # banana_df_X, banana_df_y = read_banana_data()
    X, y = _iris_data()
    monkeypatch.setattr(plt, 'show', lambda: None)
    bad_batch_sizes = [-1, -.1, 0, 1.1, 2]
    bad_split_per = [-1, -.1, 0, 1.1, 2]
    for batch_size_percent in bad_batch_sizes:
        with pytest.raises(ValueError):
            apply_model(X, y, steps=1, batch_size_percent=batch_size_percent, split_per=.8)
    for split_per in bad_split_per:
        with pytest.raises(ValueError):
            apply_model(X, y, steps=1, batch_size_percent=.8, split_per=split_per)

def test_on_iris(monkeypatch):
    X, y = _iris_data()
    
    num_qubits = 2
    num_layers = 6
    weights_init = 0.01 * np.random.randn(num_layers, num_qubits, 3, requires_grad=True)
    bias_init = np.array(0.0, requires_grad=True)

    monkeypatch.setattr(plt, 'show', lambda: None)
    apply_model(X, y, steps=10, weights_init = weights_init,
        bias_init = bias_init, batch_size_percent=.8, isPlot=True, isDebug=False)